environment:
  github_access_token:
    secure: XgRTP/48Tcb8jdBahG9aZEhKeu2qBc5gCugjShWkT+zNqcQihEtKIIonzPaGcUV+

build_script:
  - ps: |
      Write-Host "Begin download artifacts"

      # try get release by tag
      $uri = 'https://api.github.com/repos/summersun/poc/releases/tags/' + $env:APPVEYOR_REPO_TAG_NAME
      $r = Invoke-WebRequest -Uri $uri
      if(!$r.Headers.Status.contains('200 OK') {
        $host.SetShouldExit(-1)
      }
      
      $file_name = $env:APPVEYOR_REPO_TAG_NAME + ".zip"      
      $source = "http://github.com/summersun/poc/archive/" + $file_name
      $dest = $env:APPVEYOR_BUILD_FOLDER +"\" + $file_name

      # https://github.com/Azure/azure-powershell/archive/v2.2.0-September2016.zip

      (New-Object Net.WebClient).DownloadFile($source, $dest)

      7z x $file_name -o$env:APPVEYOR_BUILD_FOLDER -y

      # problem 1: find the target folders and files
      # problem 2: process the files
      # problem 3: generate toc
      # problem 4: git push files
on_success:
  - git clone -q --branch=%TargetBranch% %ContentRepo% %TEMP%\AzurePowerShell
  - ps: Get-ChildItem $env:TEMP\AzurePowerShell\$env:DocFolder -dir | Remove-Item -Recurse -Force
  - robocopy %APPVEYOR_BUILD_FOLDER%\ %TEMP%\AzurePowerShell\%DocFolder% /e & IF %ERRORLEVEL% LEQ 1 exit 0  
  - cd %TEMP%\AzurePowerShell
  - git config --global credential.helper store
  - ps: Add-Content "$env:USERPROFILE\.git-credentials" "https://$($env:github_access_token):x-oauth-basic@github.com`n"
  - git config --global user.email %Email%
  - git config --global user.name %Name%
  - git add -A
  - git commit -m "commit from appveyor"
  - git push origin %TargetBranch%
